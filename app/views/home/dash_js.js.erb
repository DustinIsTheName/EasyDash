(function() {

  var loadScript = function(url, callback) {

  	var script = document.createElement("script");
		script.type = "text/javascript";

	  // If the browser is Internet Explorer.
	  if (script.readyState){
	    script.onreadystatechange = function() {
	      if (script.readyState == "loaded" || script.readyState == "complete"){
	        script.onreadystatechange = null;
	        callback();
	      }
	    };
	  // For any other browser.
	  } else {
	    script.onload = function() {
	      callback();
	    };
	  }

	  script.src = url;
	  document.getElementsByTagName("head")[0].appendChild(script);

  }

	/* This is my app's JavaScript */
	var myAppJavaScript = function($) {

    if ( $('#admin_bar_iframe')[0] && window.location.href.indexOf('ediframe=true') === -1 ) {
    	var addendum = '?referrer=' + document.referrer;
    	var handle;
    	if (window.location.href.indexOf('/products/') > -1) {
    		handle = window.location.href.split('/products/')[1].split('?')[0];
    		addendum += '&id=handle&resource=product&handle=' + handle;
    	} else if (window.location.href.indexOf('/collections/') > -1) {
    		handle = window.location.href.split('/collections/')[1].split('?')[0];
    		addendum += '&id=handle&resource=collection&handle=' + handle;
    	} else if (window.location.href.indexOf('/pages/') > -1) {
    		handle = window.location.href.split('/pages/')[1].split('?')[0];
    		addendum += '&id=handle&resource=page&handle=' + handle;
    	} else if (window.location.href.match(/\/blogs\/[a-z]+\/([a-z-]+)/)) {
    		handle = window.location.href.match(/\/blogs\/[a-z]+\/([a-z-]+)/)[1];
    		addendum += '&id=handle&resource=blog&handle=' + handle;
    	}

      $('body').append('<%= render(partial: "home/dash_js_html/open_button").to_s.gsub(/\n/, '').html_safe %>'.replace('{{{addendum}}}', addendum));
      var top = $('html').css('padding-top');
      $('.wittyEDContainer').css('top', top);

      $('.wittyEDOpenButton').click(function() {
      	$(this).toggleClass('open');
      });

      console.log('<%= Rails.env.production? %>');

      parent.postMessage(window.location.href, '<%= Rails.env.production? ? "https://easydash.herokuapp.com" : "https://localhost:3000" %>');

      // $('.wittyEDContainer').mouseleave(function() {
      // 	$('.wittyEDOpenButton').removeClass('open');
      // });
    }

	}; // myAppJavaScript() ends here; ALL CUSTOM JS IS TO BE WITHIN THIS FUNCTION!

    // checks for jquery, loads it if undefined.
	if ((typeof jQuery === 'undefined') || (parseFloat(jQuery.fn.jquery) < 1.7)) {
	  loadScript('//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js', function(){
	    jQuery191 = jQuery.noConflict(true);
	    myAppJavaScript(jQuery191);
	  });
	} else {
	  myAppJavaScript(jQuery);
	}

})();